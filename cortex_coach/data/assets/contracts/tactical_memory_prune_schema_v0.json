{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cortex.local/contracts/tactical_memory_prune_schema_v0.json",
  "title": "Cortex Tactical Memory Prune Schema v0",
  "description": "Deterministic output contract for memory-prune tactical cleanup.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "command",
    "status",
    "project_dir",
    "run_at",
    "result"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "v0"
    },
    "command": {
      "type": "string",
      "const": "memory-prune"
    },
    "status": {
      "type": "string",
      "enum": [
        "pass",
        "fail"
      ]
    },
    "project_dir": {
      "type": "string",
      "minLength": 1
    },
    "run_at": {
      "type": "string",
      "format": "date-time"
    },
    "result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "dry_run",
        "criteria",
        "compaction",
        "ordering_policy",
        "summary",
        "actions"
      ],
      "properties": {
        "dry_run": {
          "type": "boolean"
        },
        "criteria": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "expired_before",
            "policy_violation_classes_any",
            "compaction_policy",
            "stale_before",
            "protected_content_classes_any",
            "protected_tags_any"
          ],
          "properties": {
            "expired_before": {
              "type": "string",
              "format": "date-time"
            },
            "retention_classes_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "enum": [
                  "short",
                  "standard",
                  "extended"
                ]
              }
            },
            "policy_violation_classes_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "enum": [
                  "secret",
                  "credential",
                  "pii",
                  "regulated_restricted",
                  "other_policy_violation"
                ]
              }
            },
            "compaction_policy": {
              "type": "string",
              "enum": [
                "disabled",
                "stale_only",
                "stale_and_duplicate"
              ]
            },
            "stale_before": {
              "type": "string"
            },
            "protected_content_classes_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "enum": [
                  "governance_context",
                  "implementation_note",
                  "decision_signal",
                  "risk_note",
                  "task_state",
                  "reference_excerpt",
                  "incident_note"
                ]
              }
            },
            "protected_tags_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "pattern": "^[a-z0-9][a-z0-9_.:-]{0,63}$"
              }
            }
          }
        },
        "compaction": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "policy",
            "stale_before",
            "duplicate_strategy",
            "protected_content_classes_any",
            "protected_tags_any"
          ],
          "properties": {
            "policy": {
              "type": "string",
              "enum": [
                "disabled",
                "stale_only",
                "stale_and_duplicate"
              ]
            },
            "stale_before": {
              "type": "string"
            },
            "duplicate_strategy": {
              "type": "string",
              "enum": [
                "none",
                "keep_latest_captured_at_then_record_id_asc"
              ]
            },
            "protected_content_classes_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "enum": [
                  "governance_context",
                  "implementation_note",
                  "decision_signal",
                  "risk_note",
                  "task_state",
                  "reference_excerpt",
                  "incident_note"
                ]
              }
            },
            "protected_tags_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "pattern": "^[a-z0-9][a-z0-9_.:-]{0,63}$"
              }
            }
          }
        },
        "ordering_policy": {
          "type": "string",
          "enum": [
            "decision_then_record_id_asc"
          ]
        },
        "summary": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "candidate_count",
            "pruned_count",
            "skipped_count",
            "compaction_candidate_count",
            "stale_candidate_count",
            "duplicate_candidate_count",
            "protected_skip_count"
          ],
          "properties": {
            "candidate_count": {
              "type": "integer",
              "minimum": 0
            },
            "pruned_count": {
              "type": "integer",
              "minimum": 0
            },
            "skipped_count": {
              "type": "integer",
              "minimum": 0
            },
            "compaction_candidate_count": {
              "type": "integer",
              "minimum": 0
            },
            "stale_candidate_count": {
              "type": "integer",
              "minimum": 0
            },
            "duplicate_candidate_count": {
              "type": "integer",
              "minimum": 0
            },
            "protected_skip_count": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "actions": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "record_id",
              "decision",
              "reason",
              "matched_criteria",
              "matched_policy_violation_classes",
              "protection_blocks",
              "lineage"
            ],
            "properties": {
              "record_id": {
                "type": "string",
                "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
              },
              "decision": {
                "type": "string",
                "enum": [
                  "prune",
                  "skip"
                ]
              },
              "reason": {
                "type": "string",
                "enum": [
                  "expired_ttl",
                  "policy_violation",
                  "stale_compaction",
                  "duplicate_compaction",
                  "retained_by_policy",
                  "protected_content_class",
                  "protected_tag",
                  "linked_governance_dependency",
                  "dry_run_only"
                ]
              },
              "matched_criteria": {
                "type": "array",
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "enum": [
                    "expired_ttl",
                    "policy_violation",
                    "stale_compaction",
                    "duplicate_compaction"
                  ]
                }
              },
              "matched_policy_violation_classes": {
                "type": "array",
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "enum": [
                    "secret",
                    "credential",
                    "pii",
                    "regulated_restricted",
                    "other_policy_violation"
                  ]
                }
              },
              "protection_blocks": {
                "type": "array",
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "enum": [
                    "protected_content_class",
                    "protected_tag",
                    "linked_governance_dependency"
                  ]
                }
              },
              "lineage": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "source_refs"
                ],
                "properties": {
                  "source_refs": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                      "type": "string",
                      "minLength": 1
                    }
                  },
                  "ancestor_record_ids": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "code",
        "message"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string",
          "minLength": 1
        },
        "details": {}
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "result": {
            "properties": {
              "dry_run": {
                "const": true
              }
            },
            "required": [
              "dry_run"
            ]
          }
        }
      },
      "then": {
        "properties": {
          "result": {
            "properties": {
              "summary": {
                "properties": {
                  "pruned_count": {
                    "const": 0
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "status": {
            "const": "fail"
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "error"
        ]
      }
    }
  ]
}
