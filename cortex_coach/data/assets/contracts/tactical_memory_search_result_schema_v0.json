{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cortex.local/contracts/tactical_memory_search_result_schema_v0.json",
  "title": "Cortex Tactical Memory Search Result Schema v0",
  "description": "Deterministic output contract for memory-search tactical retrieval.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "command",
    "status",
    "project_dir",
    "run_at",
    "result"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "v0"
    },
    "command": {
      "type": "string",
      "const": "memory-search"
    },
    "status": {
      "type": "string",
      "enum": [
        "pass",
        "fail"
      ]
    },
    "project_dir": {
      "type": "string",
      "minLength": 1
    },
    "run_at": {
      "type": "string",
      "format": "date-time"
    },
    "result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "query",
        "filters",
        "ranking",
        "result_count",
        "results",
        "no_match"
      ],
      "properties": {
        "query": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "query_text",
            "normalized_query",
            "requested_limit"
          ],
          "properties": {
            "query_text": {
              "type": "string",
              "minLength": 1
            },
            "normalized_query": {
              "type": "string",
              "minLength": 1
            },
            "requested_limit": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "filters": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "content_classes_any",
            "tags_any",
            "tags_all"
          ],
          "properties": {
            "content_classes_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "enum": [
                  "governance_context",
                  "implementation_note",
                  "decision_signal",
                  "risk_note",
                  "task_state",
                  "reference_excerpt",
                  "incident_note"
                ]
              }
            },
            "tags_any": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "pattern": "^[a-z0-9][a-z0-9_.:-]{0,63}$"
              }
            },
            "tags_all": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "pattern": "^[a-z0-9][a-z0-9_.:-]{0,63}$"
              }
            },
            "captured_at_from": {
              "type": "string",
              "format": "date-time"
            },
            "captured_at_to": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "ranking": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "method",
            "tie_break_order"
          ],
          "properties": {
            "method": {
              "type": "string",
              "enum": [
                "rule_based_v0",
                "bm25_v0"
              ]
            },
            "tie_break_order": {
              "type": "array",
              "const": [
                "score_desc",
                "captured_at_desc",
                "record_id_asc"
              ]
            }
          }
        },
        "result_count": {
          "type": "integer",
          "minimum": 0
        },
        "results": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "rank",
              "record_id",
              "score",
              "confidence",
              "snippet",
              "content_class",
              "tags",
              "captured_at",
              "provenance",
              "sort_key"
            ],
            "properties": {
              "rank": {
                "type": "integer",
                "minimum": 1
              },
              "record_id": {
                "type": "string",
                "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
              },
              "score": {
                "type": "number"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "snippet": {
                "type": "string",
                "minLength": 1
              },
              "content_class": {
                "type": "string",
                "enum": [
                  "governance_context",
                  "implementation_note",
                  "decision_signal",
                  "risk_note",
                  "task_state",
                  "reference_excerpt",
                  "incident_note"
                ]
              },
              "tags": {
                "type": "array",
                "uniqueItems": true,
                "items": {
                  "type": "string",
                  "pattern": "^[a-z0-9][a-z0-9_.:-]{0,63}$"
                }
              },
              "captured_at": {
                "type": "string",
                "format": "date-time"
              },
              "provenance": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "source_kind",
                  "source_ref",
                  "source_refs"
                ],
                "properties": {
                  "source_kind": {
                    "type": "string",
                    "enum": [
                      "manual_capture",
                      "context_hydration",
                      "adapter_signal",
                      "derived_summary",
                      "imported"
                    ]
                  },
                  "source_ref": {
                    "type": "string",
                    "minLength": 1
                  },
                  "source_refs": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                      "type": "string",
                      "minLength": 1
                    }
                  }
                }
              },
              "sort_key": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "score",
                  "captured_at",
                  "record_id"
                ],
                "properties": {
                  "score": {
                    "type": "number"
                  },
                  "captured_at": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "record_id": {
                    "type": "string",
                    "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
                  }
                }
              }
            }
          }
        },
        "no_match": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "matched",
            "reason"
          ],
          "properties": {
            "matched": {
              "type": "boolean"
            },
            "reason": {
              "type": "string",
              "enum": [
                "matches_found",
                "no_match",
                "filtered_out"
              ]
            },
            "suggestion": {
              "type": "string",
              "minLength": 1
            }
          }
        }
      }
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "code",
        "message"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string",
          "minLength": 1
        },
        "details": {}
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "result": {
            "properties": {
              "result_count": {
                "const": 0
              }
            },
            "required": [
              "result_count"
            ]
          }
        }
      },
      "then": {
        "properties": {
          "result": {
            "properties": {
              "results": {
                "maxItems": 0
              },
              "no_match": {
                "properties": {
                  "matched": {
                    "const": false
                  }
                },
                "required": [
                  "matched"
                ]
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "status": {
            "const": "fail"
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "error"
        ]
      }
    }
  ]
}
