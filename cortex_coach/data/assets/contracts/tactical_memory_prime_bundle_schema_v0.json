{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cortex.local/contracts/tactical_memory_prime_bundle_schema_v0.json",
  "title": "Cortex Tactical Memory Prime Bundle Schema v0",
  "description": "Deterministic output contract for memory-prime bounded context bundles.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "command",
    "status",
    "project_dir",
    "run_at",
    "result"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "v0"
    },
    "command": {
      "type": "string",
      "const": "memory-prime"
    },
    "status": {
      "type": "string",
      "enum": [
        "pass",
        "fail"
      ]
    },
    "project_dir": {
      "type": "string",
      "minLength": 1
    },
    "run_at": {
      "type": "string",
      "format": "date-time"
    },
    "result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "input",
        "budget",
        "ordering_policy",
        "selected_count",
        "selected_char_count",
        "bundle",
        "truncation"
      ],
      "properties": {
        "input": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "task",
            "query_ref",
            "requested_limit"
          ],
          "properties": {
            "task": {
              "type": "string",
              "minLength": 1
            },
            "query_ref": {
              "type": "string",
              "minLength": 1
            },
            "requested_limit": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "budget": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "max_records",
            "max_chars",
            "per_record_max_chars"
          ],
          "properties": {
            "max_records": {
              "type": "integer",
              "minimum": 1
            },
            "max_chars": {
              "type": "integer",
              "minimum": 1
            },
            "per_record_max_chars": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "ordering_policy": {
          "type": "string",
          "enum": [
            "relevance_desc_then_recency_desc_then_record_id_asc"
          ]
        },
        "selected_count": {
          "type": "integer",
          "minimum": 0
        },
        "selected_char_count": {
          "type": "integer",
          "minimum": 0
        },
        "bundle": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "position",
              "record_id",
              "summary",
              "char_count",
              "source_provenance"
            ],
            "properties": {
              "position": {
                "type": "integer",
                "minimum": 1
              },
              "record_id": {
                "type": "string",
                "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
              },
              "summary": {
                "type": "string",
                "minLength": 1
              },
              "char_count": {
                "type": "integer",
                "minimum": 0
              },
              "content_class": {
                "type": "string",
                "enum": [
                  "governance_context",
                  "implementation_note",
                  "decision_signal",
                  "risk_note",
                  "task_state",
                  "reference_excerpt",
                  "incident_note"
                ]
              },
              "source_provenance": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "source_kind",
                  "source_ref",
                  "source_refs"
                ],
                "properties": {
                  "source_kind": {
                    "type": "string",
                    "enum": [
                      "manual_capture",
                      "context_hydration",
                      "adapter_signal",
                      "derived_summary",
                      "imported"
                    ]
                  },
                  "source_ref": {
                    "type": "string",
                    "minLength": 1
                  },
                  "source_refs": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                      "type": "string",
                      "minLength": 1
                    }
                  }
                }
              }
            }
          }
        },
        "truncation": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "applied",
            "reason",
            "dropped_record_ids",
            "truncated_record_count",
            "truncated_char_count"
          ],
          "properties": {
            "applied": {
              "type": "boolean"
            },
            "reason": {
              "type": "string",
              "enum": [
                "none",
                "record_limit",
                "char_budget",
                "per_record_char_limit"
              ]
            },
            "dropped_record_ids": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^tmr_[a-z0-9][a-z0-9_-]{5,}$"
              }
            },
            "truncated_record_count": {
              "type": "integer",
              "minimum": 0
            },
            "truncated_char_count": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "code",
        "message"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string",
          "minLength": 1
        },
        "details": {}
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "status": {
            "const": "fail"
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "error"
        ]
      }
    }
  ]
}
